<script>
    // Año en el footer (si lo tienes)
    const yearEl = document.getElementById('current-year');
    if (yearEl) {
        yearEl.textContent = new Date().getFullYear();
    }

    // Variable global para poder ver el detalle en el modal
    let ultimaBusqueda = [];

    // ------------ FUNCIÓN PRINCIPAL DE BÚSQUEDA ------------
    function buscar(event) {
        event.preventDefault();

        const textoBuscar = document.getElementById('textoBuscar').value.trim();
        if (!textoBuscar) {
            alert('Por favor, ingresa un texto para buscar');
            return;
        }

        // Ocultar resultados y error anteriores
        document.getElementById('divResultados').style.display = 'none';
        document.getElementById('divError').style.display = 'none';
        document.getElementById('mensajeError').textContent = '';

        // Mostrar spinner
        document.getElementById('div_cargando').style.display = 'block';

        fetch('/buscar-elastic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ texto: textoBuscar })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('div_cargando').style.display = 'none';

            if (data.success) {
                mostrarResultados(data);
            } else {
                mostrarError(data.error || 'Error desconocido en la búsqueda');
            }
        })
        .catch(error => {
            console.error('Error en la petición /buscar-elastic:', error);
            document.getElementById('div_cargando').style.display = 'none';
            mostrarError('Error al realizar la búsqueda');
        });
    }

    // ------------ MOSTRAR RESULTADOS ------------
    function mostrarResultados(data) {
        // Asegurarse de ocultar cualquier error anterior
        document.getElementById('divError').style.display = 'none';
        document.getElementById('mensajeError').textContent = '';

        // Total encontrados
        document.getElementById('totalResultados').textContent = data.total || 0;

        // Aggregations (filtros)
        mostrarAggregations(data.aggs || {});

        // Hits / resultados
        mostrarHits(data.resultados || []);

        // Mostrar contenedor de resultados
        document.getElementById('divResultados').style.display = 'block';
    }

    // ------------ AGGREGATIONS (FILTROS) ------------
    function mostrarAggregations(aggs) {
        const divAggregations = document.getElementById('divAggregations');
        if (!divAggregations) return;

        divAggregations.innerHTML = '';

        if (!aggs || Object.keys(aggs).length === 0) {
            divAggregations.innerHTML =
                '<p class="text-muted mb-0">No hay filtros disponibles para esta búsqueda.</p>';
            return;
        }

        // Si en algún momento agregas aggregations, aquí las pintas.
        // Por ahora, simplemente mostramos un mensajito.
        divAggregations.innerHTML =
            '<p class="text-muted mb-0">Se recibieron aggregations, pero aún no las estamos mostrando en detalle.</p>';
    }

    // ------------ MOSTRAR TABLA DE HITS ------------
    function mostrarHits(hits) {
        const tablaResultados = document.getElementById('tablaResultados');
        tablaResultados.innerHTML = '';

        // Guardamos para el modal "Ver completo"
        ultimaBusqueda = hits;

        if (!hits.length) {
            tablaResultados.innerHTML =
                '<tr><td colspan="5" class="text-center">No se encontraron resultados</td></tr>';
            return;
        }

        hits.forEach((hit, index) => {
            const row = document.createElement('tr');
            const source = hit._source || {};

            // Vista corta del contenido
            let contenidoVista = '';
            if (source.contenido) {
                contenidoVista = source.contenido.substring(0, 250);
                if (source.contenido.length > 250) contenidoVista += '...';
            } else if (source.texto) {
                contenidoVista = source.texto.substring(0, 250);
                if (source.texto.length > 250) contenidoVista += '...';
            } else {
                const sourceStr = JSON.stringify(source, null, 2);
                contenidoVista = sourceStr.substring(0, 250);
                if (sourceStr.length > 250) contenidoVista += '...';
            }

            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${hit._id || ''}</td>
                <td>${hit._score ? hit._score.toFixed(4) : 'N/A'}</td>
                <td><small>${hit._index || ''}</small></td>
                <td>
                    <div class="json-view">${contenidoVista}</div>
                    <button class="btn btn-sm btn-link mt-1"
                            onclick="mostrarDetalle(${index})"
                            data-bs-toggle="modal"
                            data-bs-target="#modalDetalle">
                        Ver completo
                    </button>
                </td>
            `;
            tablaResultados.appendChild(row);
        });
    }

    // ------------ MOSTRAR ERROR ------------
    function mostrarError(mensaje) {
        const divError = document.getElementById('divError');
        const spanMensaje = document.getElementById('mensajeError');

        if (spanMensaje) spanMensaje.textContent = mensaje || 'Error desconocido';
        if (divError) divError.style.display = 'flex'; // o 'block' según tu diseño
    }

    // ------------ DETALLE COMPLETO EN EL MODAL ------------
    function mostrarDetalle(index) {
        const modalBody = document.getElementById('modalDetalleBody');
        if (!modalBody || !ultimaBusqueda[index]) return;

        const source = ultimaBusqueda[index]._source || {};
        modalBody.innerHTML =
            `<pre class="json-view" style="max-height: 500px; overflow-y: auto;">${JSON.stringify(source, null, 2)}</pre>`;
    }
</script>
